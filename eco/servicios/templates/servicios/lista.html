{% extends 'base.html' %}
{% block title %}Servicios asociados{% endblock %}
{% block content %}

<h1 class="text-2xl font-bold mb-4">Servicios asociados</h1>

{% if user.is_authenticated and user.prestador %}
  <button 
    hx-get="{% url 'crear_servicio' %}" 
    hx-target="#modal-contenido"
    hx-swap="innerHTML"
    class="bg-emerald-600 text-white px-4 py-2 rounded">
    + Publicar servicio
  </button>
{% endif %}

<div class="flex gap-2 mt-3">
  <form method="GET" hx-get="{% url 'lista_servicios' %}" hx-target="#servicios" hx-swap="outerHTML">
    <input type="text" name="comuna" placeholder="Filtrar por comuna" class="border rounded px-3 py-1">
    <button class="bg-slate-200 px-3 py-1 rounded">Filtrar</button>
  </form>
</div>

<div id="servicios" class="grid md:grid-cols-3 gap-4 mt-4">
  {% for s in servicios %}
  <article class="bg-white rounded-2xl shadow p-4" id="servicio-{{ s.pk }}">
    <h2 class="font-semibold">{{ s.titulo }}</h2>
    <p class="text-sm text-slate-500">{{ s.get_tipo_display }} · {{ s.comuna }}</p>
    <p class="mt-2">{{ s.descripcion|truncatechars:100 }}</p>
    <p class="mt-2 font-bold">${{ s.precio_base }}</p>
    {% if user == s.prestador.usuario %}
    <div class="mt-3 flex gap-2">
      <button 
        hx-get="{% url 'editar_servicio' s.pk %}" 
        hx-target="#modal-contenido"
        hx-swap="innerHTML"
        class="text-blue-600 underline">Editar</button>
      <button 
        hx-delete="{% url 'eliminar_servicio' s.pk %}" 
        hx-target="#servicio-{{ s.pk }}"
        hx-swap="outerHTML"
        class="text-red-600 underline">Eliminar</button>
    </div>
    {% else %}
    <a href="mailto:{{ s.prestador.email_contacto }}" class="text-emerald-700 underline">Contactar</a>
    {% endif %}
  </article>
  {% empty %}
  <p>No hay servicios publicados aún.</p>
  {% endfor %}
</div>

<div id="modal" class="fixed inset-0 hidden bg-black bg-opacity-40 items-center justify-center">
  <div id="modal-contenido" class="bg-white rounded-2xl p-6 shadow-xl w-full max-w-lg"></div>
</div>

<script>
  document.body.addEventListener('htmx:afterSwap', (e) => {
    if (e.detail.target.id === 'modal-contenido') {
      document.getElementById('modal').classList.remove('hidden');
    }
  });
  document.body.addEventListener('click', (e) => {
    if (e.target.id === 'modal') {
      document.getElementById('modal').classList.add('hidden');
    }
  });
</script>

{% endblock %}
